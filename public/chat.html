<script>
  document.addEventListener("DOMContentLoaded", async () => {
    console.log("DOM loaded for chat.html");
    console.log("Ionic version:", window.Ionic?.version || "Not loaded");
    const token = localStorage.getItem("token");
    if (!token) {
      console.log("No token found, redirecting to /login.html");
      window.location.href = "/login.html";
      return;
    }
    console.log("Token found:", token);

    // Menu navigation
    const navItems = {
      "nav-dashboard": "/index.html",
      "nav-calendar": "/calendar.html",
      "nav-tasks": "/tasks.html",
      "nav-chat": "/chat.html",
      "nav-family": "/family.html",
    };
    Object.keys(navItems).forEach((id) => {
      const item = document.getElementById(id);
      item?.addEventListener("click", () => {
        const url = navItems[id];
        console.log(`Navigating to ${url}`);
        window.location.href = url;
      });
    });

    // Sign out
    document.getElementById("signOut")?.addEventListener("click", () => {
      console.log("Sign out clicked");
      localStorage.removeItem("token");
      console.log("Logged out, cleared token");
      window.location.href = "/login.html";
    });

    const chatList = document.getElementById("chat_list");

    async function fetchUser() {
      try {
        console.log("Fetching user info");
        const response = await fetch("http://localhost:8100/user", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        });
        const data = await response.json();
        console.log("Fetch user response:", data);
        if (!response.ok) {
          throw new Error(data.error || "Failed to fetch user data");
        }
        return {
          username: data.username || "Guest",
          email: data.email || "No email",
          user_id: data.user_id,
        };
      } catch (err) {
        console.error("Error fetching user:", err);
        return { username: "Guest", email: "Not logged in", user_id: null };
      }
    }

    async function fetchMessages() {
      try {
        console.log("Fetching messages");
        const response = await fetch("http://localhost:8100/messages", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        });
        const data = await response.json();
        console.log("Fetch messages response:", data);
        if (!response.ok) {
          if (data.error === "User not in a family") {
            console.log("User not in a family, showing toast");
            const toast = document.createElement("ion-toast");
            toast.message = "Please create or join a family first";
            toast.duration = 3000;
            toast.color = "warning";
            toast.buttons = [
              {
                text: "Go to Family",
                handler: () => {
                  console.log("Toast button clicked, redirecting to /family.html");
                  window.location.href = "/family.html";
                },
              },
            ];
            document.body.appendChild(toast);
            await toast.present();
          }
          throw new Error(data.error || "Failed to fetch messages");
        }
        return data.messages;
      } catch (error) {
        console.error("Error fetching messages:", error);
        const toast = document.createElement("ion-toast");
        toast.message = `Failed to load messages: ${error.message}`;
        toast.duration = 2000;
        toast.color = "danger";
        document.body.appendChild(toast);
        await toast.present();
        return [];
      }
    }

    async function renderMessages() {
      try {
        const messages = await fetchMessages();
        const user = await fetchUser();
        chatList.innerHTML = "";
        messages.forEach((message) => {
          const div = document.createElement("div");
          div.className = `message ${message.sender_id === user.user_id ? "sent" : "received"}`;
          div.innerHTML = `
            <ion-avatar slot="start">
              <img src="/assets/user-${message.sender_id}.png" alt="${message.sender_username}" onerror="this.src='/assets/user-default.png'" />
            </ion-avatar>
            <strong>${message.sender_username}</strong> (${new Date(message.sent_at).toLocaleString()}):
            <p>${message.content}</p>
          `;
          chatList.appendChild(div);
        });
        chatList.scrollTop = chatList.scrollHeight;
      } catch (error) {
        console.error("Error rendering messages:", error);
      }
    }

    await renderMessages();
    setInterval(renderMessages, 5000);

    document.getElementById("message_form")?.addEventListener("submit", async (event) => {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      const content = formData.get("content")?.toString().trim();
      console.log("Message form submitted:", { content });

      if (!content) {
        console.log("Missing message content");
        const toast = document.createElement("ion-toast");
        toast.message = "Message content is required";
        toast.duration = 2000;
        toast.color = "danger";
        document.body.appendChild(toast);
        await toast.present();
        return;
      }

      try {
        console.log("Sending message creation request");
        const response = await fetch("http://localhost:8100/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ content }),
        });
        const data = await response.json();
        console.log("Message creation response:", data);
        if (!response.ok) {
          if (data.error === "User not in a family") {
            console.log("User not in a family, showing toast");
            const toast = document.createElement("ion-toast");
            toast.message = "Please create or join a family first";
            toast.duration = 3000;
            toast.color = "warning";
            toast.buttons = [
              {
                text: "Go to Family",
                handler: () => {
                  console.log("Toast button clicked, redirecting to /family.html");
                  window.location.href = "/family.html";
                },
              },
            ];
            document.body.appendChild(toast);
            await toast.present();
          } else {
            throw new Error(data.error || "Failed to send message");
          }
        } else {
          console.log("Message sent, refetching messages");
          await renderMessages();
          const toast = document.createElement("ion-toast");
          toast.message = "Message Sent";
          toast.duration = 2000;
          toast.color = "success";
          document.body.appendChild(toast);
          await toast.present();
          form.reset();
        }
      } catch (error) {
        console.error("Error sending message:", error);
        const toast = document.createElement("ion-toast");
        toast.message = `Failed to send message: ${error.message}`;
        toast.duration = 2000;
        toast.color = "danger";
        document.body.appendChild(toast);
        await toast.present();
      }
    });
  });
</script>