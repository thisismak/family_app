<script>
  document.addEventListener("DOMContentLoaded", async () => {
    console.log("DOM loaded for tasks.html");
    console.log("Ionic version:", window.Ionic?.version || "Not loaded");
    const token = localStorage.getItem("token");
    if (!token) {
      console.log("No token found, redirecting to /login.html");
      window.location.href = "/login.html";
      return;
    }
    console.log("Token found:", token);

    // Menu navigation
    const navItems = {
      "nav-dashboard": "/index.html",
      "nav-calendar": "/calendar.html",
      "nav-tasks": "/tasks.html",
      "nav-chat": "/chat.html",
      "nav-family": "/family.html",
    };
    Object.keys(navItems).forEach((id) => {
      const item = document.getElementById(id);
      item?.addEventListener("click", () => {
        const url = navItems[id];
        console.log(`Navigating to ${url}`);
        window.location.href = url;
      });
    });

    // Sign out
    document.getElementById("signOut")?.addEventListener("click", () => {
      console.log("Sign out clicked");
      localStorage.removeItem("token");
      console.log("Logged out, cleared token");
      window.location.href = "/login.html";
    });

    const taskList = document.getElementById("task_list");
    const assigneeSelect = document.getElementById("assignee_id");

    async function fetchFamilyMembers() {
      try {
        console.log("Fetching tasks");
        const taskResponse = await fetch("http://localhost:8100/tasks", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        });
        const taskData = await taskResponse.json();
        console.log("Fetch tasks response:", taskData);
        if (!taskResponse.ok) {
          if (taskData.error === "User not in a family") {
            console.log("User not in a family, showing toast");
            const toast = document.createElement("ion-toast");
            toast.message = "Please create or join a family first";
            toast.duration = 3000;
            toast.color = "warning";
            toast.buttons = [
              {
                text: "Go to Family",
                handler: () => {
                  console.log("Toast button clicked, redirecting to /family.html");
                  window.location.href = "/family.html";
                },
              },
            ];
            document.body.appendChild(toast);
            await toast.present();
          }
          throw new Error(taskData.error || "Failed to fetch tasks");
        }

        // Fetch user's families to get family_id
        console.log("Fetching user's families");
        const familyResponse = await fetch("http://localhost:8100/my-families", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        });
        const familyData = await familyResponse.json();
        console.log("Fetch families response:", familyData);
        if (!familyResponse.ok) {
          throw new Error(familyData.error || "Failed to fetch families");
        }
        if (familyData.families.length === 0) {
          throw new Error("User not in a family");
        }
        const familyId = familyData.families[0].id;

        // Fetch family members
        console.log(`Fetching members for family ID: ${familyId}`);
        const memberResponse = await fetch(`http://localhost:8100/family/members?family_id=${familyId}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        });
        const memberData = await memberResponse.json();
        console.log("Fetch family members response:", memberData);
        if (!memberResponse.ok) {
          throw new Error(memberData.error || "Failed to fetch family members");
        }

        assigneeSelect.innerHTML = '<ion-select-option value="">None</ion-select-option>';
        memberData.members.forEach((member) => {
          const option = document.createElement("ion-select-option");
          option.value = member.user_id;
          option.textContent = member.username;
          assigneeSelect.appendChild(option);
        });

        return taskData.tasks;
      } catch (error) {
        console.error("Error fetching family members or tasks:", error);
        const toast = document.createElement("ion-toast");
        toast.message = `Failed to load tasks: ${error.message}`;
        toast.duration = 2000;
        toast.color = "danger";
        document.body.appendChild(toast);
        await toast.present();
        return [];
      }
    }

    async function renderTasks() {
      try {
        const tasks = await fetchFamilyMembers();
        taskList.innerHTML = "";
        tasks.forEach((task) => {
          const item = document.createElement("ion-item");
          item.className = task.status === "completed" ? "completed" : "";
          item.innerHTML = `
            <ion-avatar slot="start">
              <img src="/assets/user-${task.assignee_id || "default"}.png" alt="${task.assignee_username || "No assignee"}" onerror="this.src='/assets/user-default.png'" />
            </ion-avatar>
            <ion-label>
              <h2>${task.title}</h2>
              <p>${task.description || "No description"}</p>
              <p>Assignee: ${task.assignee_username || "None"}</p>
              <p>Due: ${task.due_date ? new Date(task.due_date).toLocaleDateString() : "No due date"}</p>
              <p>Priority: ${task.priority}</p>
              <p>Status: ${task.status}</p>
            </ion-label>
            <ion-button slot="end" fill="clear" id="toggle-${task.id}">
              <ion-icon name="${task.status === "pending" ? "checkmark-circle-outline" : "refresh-circle-outline"}"></ion-icon>
            </ion-button>
          `;
          taskList.appendChild(item);
          document.getElementById(`toggle-${task.id}`)?.addEventListener("click", () => toggleTaskStatus(task.id, task.status));
        });
      } catch (error) {
        console.error("Error rendering tasks:", error);
      }
    }

    async function toggleTaskStatus(taskId, currentStatus) {
      const newStatus = currentStatus === "pending" ? "completed" : "pending";
      try {
        console.log(`Toggling task ${taskId} to ${newStatus}`);
        const response = await fetch(`http://localhost:8100/tasks/${taskId}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ status: newStatus }),
        });
        const data = await response.json();
        console.log("Toggle task response:", data);
        if (!response.ok) {
          throw new Error(data.error || "Failed to update task");
        }
        await renderTasks();
        const toast = document.createElement("ion-toast");
        toast.message = `Task marked as ${newStatus}`;
        toast.duration = 2000;
        toast.color = "success";
        document.body.appendChild(toast);
        await toast.present();
      } catch (error) {
        console.error("Error toggling task:", error);
        const toast = document.createElement("ion-toast");
        toast.message = `Failed to update task: ${error.message}`;
        toast.duration = 2000;
        toast.color = "danger";
        document.body.appendChild(toast);
        await toast.present();
      }
    }

    await renderTasks();

    document.getElementById("task_form")?.addEventListener("submit", async (event) => {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      const title = formData.get("title")?.toString().trim();
      const description = formData.get("description")?.toString().trim() || null;
      const assignee_id = formData.get("assignee_id") || null;
      const due_date = formData.get("due_date")?.toString();
      const priority = formData.get("priority")?.toString() || "medium";

      // Client-side validation
      if (!title) {
        const toast = document.createElement("ion-toast");
        toast.message = "Task title is required";
        toast.duration = 2000;
        toast.color = "danger";
        document.body.appendChild(toast);
        await toast.present();
        return;
      }
      if (title.length > 100) {
        const toast = document.createElement("ion-toast");
        toast.message = "Task title must be 100 characters or less";
        toast.duration = 2000;
        toast.color = "danger";
        document.body.appendChild(toast);
        await toast.present();
        return;
      }
      if (!["low", "medium", "high"].includes(priority)) {
        const toast = document.createElement("ion-toast");
        toast.message = "Invalid priority value";
        toast.duration = 2000;
        toast.color = "danger";
        document.body.appendChild(toast);
        await toast.present();
        return;
      }

      console.log("Task form submitted:", { title, description, assignee_id, due_date, priority });

      try {
        console.log("Sending task creation request");
        const response = await fetch("http://localhost:8100/tasks", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            title,
            description,
            assignee_id: assignee_id ? Number(assignee_id) : null,
            due_date: due_date ? new Date(due_date).toISOString().split("T")[0] : null,
            priority,
          }),
        });
        const data = await response.json();
        console.log("Task creation response:", data);
        if (!response.ok) {
          if (data.error === "User not in a family") {
            console.log("User not in a family, showing toast");
            const toast = document.createElement("ion-toast");
            toast.message = "Please create or join a family first";
            toast.duration = 3000;
            toast.color = "warning";
            toast.buttons = [
              {
                text: "Go to Family",
                handler: () => {
                  console.log("Toast button clicked, redirecting to /family.html");
                  window.location.href = "/family.html";
                },
              },
            ];
            document.body.appendChild(toast);
            await toast.present();
          }
          throw new Error(data.error || "Failed to create task");
        }
        console.log("Task created, refetching tasks");
        await renderTasks();
        const toast = document.createElement("ion-toast");
        toast.message = "Task Created";
        toast.duration = 2000;
        toast.color = "success";
        document.body.appendChild(toast);
        await toast.present();
        form.reset();
      } catch (error) {
        console.error("Error creating task:", error);
        const toast = document.createElement("ion-toast");
        toast.message = `Failed to create task: ${error.message}`;
        toast.duration = 2000;
        toast.color = "danger";
        document.body.appendChild(toast);
        await toast.present();
      }
    });
  });
</script>