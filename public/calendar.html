<script>
  document.addEventListener("DOMContentLoaded", async () => {
    console.log("DOM loaded for calendar.html");
    console.log("Ionic version:", window.Ionic?.version || "Not loaded");
    const token = localStorage.getItem("token");
    if (!token) {
      console.log("No token found, redirecting to /login.html");
      window.location.href = "/login.html";
      return;
    }
    console.log("Token found:", token);

    // Menu navigation
    const navItems = {
      "nav-dashboard": "/index.html",
      "nav-calendar": "/calendar.html",
      "nav-tasks": "/tasks.html",
      "nav-chat": "/chat.html",
      "nav-family": "/family.html",
    };
    Object.keys(navItems).forEach((id) => {
      const item = document.getElementById(id);
      item?.addEventListener("click", () => {
        const url = navItems[id];
        console.log(`Navigating to ${url}`);
        window.location.href = url;
      });
    });

    // Sign out
    document.getElementById("signOut")?.addEventListener("click", () => {
      console.log("Sign out clicked");
      localStorage.removeItem("token");
      console.log("Logged out, cleared token");
      window.location.href = "/login.html";
    });

    const calendarEl = document.getElementById("calendar");
    if (!calendarEl) {
      console.error("Calendar element not found");
      return;
    }

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      initialDate: new Date().toISOString().split("T")[0],
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay",
      },
      height: "auto",
      contentHeight: "auto",
      aspectRatio: 1.5,
      eventTimeFormat: {
        hour: "2-digit",
        minute: "2-digit",
        hour12: true,
        meridiem: "short",
      },
      events: async (fetchInfo, successCallback, failureCallback) => {
        try {
          console.log("Fetching events");
          const response = await fetch("http://localhost:8100/calendar", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
          });
          const data = await response.json();
          console.log("Fetch events response:", data);
          if (!response.ok) {
            if (data.error === "User not in a family") {
              console.log("User not in a family, showing toast");
              const toast = document.createElement("ion-toast");
              toast.message = "Please create or join a family first";
              toast.duration = 3000;
              toast.color = "warning";
              toast.buttons = [
                {
                  text: "Go to Family",
                  handler: () => {
                    console.log("Toast button clicked, redirecting to /family.html");
                    window.location.href = "/family.html";
                  },
                },
              ];
              document.body.appendChild(toast);
              await toast.present();
            }
            throw new Error(data.error || "Failed to fetch events");
          }
          const events = data.events
            .map((event) => {
              const start = new Date(event.start_datetime);
              const end = event.end_datetime ? new Date(event.end_datetime) : null;
              if (isNaN(start.getTime())) {
                console.warn(`Invalid start date for event ${event.id}: ${event.start_datetime}`);
                return null;
              }
              return {
                id: event.id,
                title: event.title,
                start: start.toISOString(),
                end: end && !isNaN(end.getTime()) ? end.toISOString() : null,
              };
            })
            .filter((event) => event !== null);
          console.log("Events loaded:", events);
          successCallback(events);
        } catch (error) {
          console.error("Error fetching events:", error);
          failureCallback(error);
          const toast = document.createElement("ion-toast");
          toast.message = `Failed to load events: ${error.message}`;
          toast.duration = 3000;
          toast.color = "danger";
          document.body.appendChild(toast);
          await toast.present();
        }
      },
      eventClick: (info) => {
        const start = new Date(info.event.start).toLocaleString();
        const end = info.event.end ? new Date(info.event.end).toLocaleString() : "N/A";
        console.log("Event clicked:", info.event.title);
        alert(`Event: ${info.event.title}\nStart: ${start}\nEnd: ${end}`);
      },
      datesSet: () => {
        console.log("Calendar dates set, updating size");
        calendar.updateSize();
      },
    });

    setTimeout(() => {
      console.log("Rendering calendar");
      calendar.render();
      calendar.updateSize();
    }, 100);

    window.addEventListener("resize", () => {
      console.log("Window resized, updating calendar size");
      calendar.updateSize();
    });

    document.getElementById("event_form")?.addEventListener("submit", async (event) => {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      const title = formData.get("title")?.toString().trim();
      let start_datetime = formData.get("start_datetime");
      let end_datetime = formData.get("end_datetime");
      let reminder_datetime = formData.get("reminder_datetime");
      console.log("Event form submitted:", { title, start_datetime, end_datetime, reminder_datetime });

      if (!title || !start_datetime) {
        console.log("Missing title or start date");
        const toast = document.createElement("ion-toast");
        toast.message = "Title and start date are required";
        toast.duration = 2000;
        toast.color = "danger";
        document.body.appendChild(toast);
        await toast.present();
        return;
      }

      try {
        start_datetime = start_datetime ? new Date(start_datetime).toISOString() : null;
        end_datetime = end_datetime ? new Date(end_datetime).toISOString() : null;
        reminder_datetime = reminder_datetime ? new Date(reminder_datetime).toISOString() : null;

        if (!start_datetime || isNaN(new Date(start_datetime).getTime())) {
          throw new Error("Invalid start date");
        }
      } catch (error) {
        console.error("Invalid date format:", error);
        const toast = document.createElement("ion-toast");
        toast.message = "Invalid date format";
        toast.duration = 2000;
        toast.color = "danger";
        document.body.appendChild(toast);
        await toast.present();
        return;
      }

      try {
        console.log("Sending event creation request");
        const response = await fetch("http://localhost:8100/calendar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            title,
            start_datetime,
            end_datetime,
            reminder_datetime,
          }),
        });
        const data = await response.json();
        console.log("Event creation response:", data);
        if (!response.ok) {
          if (data.error === "User not in a family") {
            console.log("User not in a family, showing toast");
            const toast = document.createElement("ion-toast");
            toast.message = "Please create or join a family first";
            toast.duration = 3000;
            toast.color = "warning";
            toast.buttons = [
              {
                text: "Go to Family",
                handler: () => {
                  console.log("Toast button clicked, redirecting to /family.html");
                  window.location.href = "/family.html";
                },
              },
            ];
            document.body.appendChild(toast);
            await toast.present();
          } else {
            throw new Error(data.error || "Failed to create event");
          }
        } else {
          console.log("Event created, refetching events");
          calendar.refetchEvents();
          setTimeout(() => {
            console.log("Re-rendering calendar");
            calendar.render();
            calendar.updateSize();
          }, 100);
          const toast = document.createElement("ion-toast");
          toast.message = "Event Created";
          toast.duration = 2000;
          toast.color = "success";
          document.body.appendChild(toast);
          await toast.present();
          form.reset();
        }
      } catch (error) {
        console.error("Error creating event:", error);
        const toast = document.createElement("ion-toast");
        toast.message = `Failed to create event: ${error.message}`;
        toast.duration = 2000;
        toast.color = "danger";
        document.body.appendChild(toast);
        await toast.present();
      }
    });
  });
</script>