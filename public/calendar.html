<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S&S 家庭應用程式 - 日曆</title>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core@7.2.1/dist/ionic/ionic.esm.js"></script>
  <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core@7.2.1/dist/ionic/ionic.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core@7.2.1/css/ionic.bundle.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/5.6.4/antd.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" />
  <link rel="stylesheet" href="/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    ion-avatar {
      width: 40px;
      height: 40px;
      margin-right: 8px;
    }
    body {
      font-family: Microsoft JhengHei, Poppins, sans-serif;
      padding: 20px;
    }
    .ant-picker, .ant-select {
      width: 100%;
    }
    #calendar {
      max-width: 900px;
      margin: 0 auto;
    }
    .form-container {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <ion-app>
    <ion-menu content-id="main-content" side="start">
      <ion-header>
        <ion-toolbar>
          <ion-title>選單</ion-title>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-list id="nav-list">
          <ion-item button id="nav-dashboard"><ion-icon name="home-outline"></ion-icon>儀表板</ion-item>
          <ion-item button id="nav-calendar"><ion-icon name="calendar-outline"></ion-icon>日曆</ion-item>
          <ion-item button id="nav-tasks"><ion-icon name="checkbox-outline"></ion-icon>任務</ion-item>
          <ion-item button id="nav-chat"><ion-icon name="chatbubble-outline"></ion-icon>聊天</ion-item>
          <ion-item button id="nav-family"><ion-icon name="people-outline"></ion-icon>家庭</ion-item>
          <ion-item button id="signOut"><ion-icon name="log-out-outline"></ion-icon>登出</ion-item>
        </ion-list>
      </ion-content>
    </ion-menu>
    <div class="ion-page" id="main-content">
      <ion-header>
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-menu-button></ion-menu-button>
          </ion-buttons>
          <ion-title>S&S 家庭應用程式 - 日曆</ion-title>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <img src="/assets/family-logo.png" alt="家庭標誌" class="family-logo" />
        <div class="welcome-message">
          <h2>您的家庭日曆</h2>
          <p>管理您的家庭活動與日程。</p>
        </div>
        <ion-card class="form-container">
          <ion-card-header>
            <ion-card-title>新增事件</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div id="event-form-root"></div>
          </ion-card-content>
        </ion-card>
        <ion-card>
          <ion-card-header>
            <ion-card-title>日曆視圖</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div id="calendar"></div>
          </ion-card-content>
        </ion-card>
      </ion-content>
      <ion-footer>
        <ion-toolbar>
          <ion-title size="small" class="ion-text-center">
            © 2025 S&S 家庭應用程式。版權所有。
          </ion-title>
        </ion-toolbar>
      </ion-footer>
    </div>
  </ion-app>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/dayjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/locale/zh-tw.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/antd/5.6.4/antd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/zh-tw.js"></script>

  <script type="text/babel">
    const { Form, Input, Button, DatePicker, Select } = window.antd;
    const { useState } = React;
    dayjs.locale('zh-tw');

    // 事件表單組件
    const EventForm = ({ onEventCreated }) => {
      const [form] = Form.useForm();

      const onFinish = async (values) => {
        const token = localStorage.getItem("token") || sessionStorage.getItem("token");
        try {
          const response = await fetch("http://localhost:8100/calendar", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              title: values.title,
              start_datetime: values.dates[0].toISOString(),
              end_datetime: values.dates[1].toISOString(),
              category: values.category,
              reminder_datetime: values.reminder ? values.reminder.toISOString() : null,
            }),
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || "無法創建事件");
          }
          showToast("事件創建成功", 2000, "success");
          form.resetFields();
          onEventCreated();
        } catch (error) {
          showToast(`創建事件失敗: ${error.message}`, 3000, "danger");
        }
      };

      return (
        <Form form={form} onFinish={onFinish} layout="vertical">
          <Form.Item name="title" label="事件標題" rules={[{ required: true, message: '請輸入事件標題' }]}>
            <Input />
          </Form.Item>
          <Form.Item name="dates" label="開始與結束時間" rules={[{ required: true, message: '請選擇時間範圍' }]}>
            <DatePicker.RangePicker showTime={{ format: 'HH' }} />
          </Form.Item>
          <Form.Item name="category" label="類別" rules={[{ required: true, message: '請選擇類別' }]}>
            <Select>
              <Select.Option value="family">家庭</Select.Option>
              <Select.Option value="work">工作</Select.Option>
              <Select.Option value="school">學校</Select.Option>
              <Select.Option value="personal">個人</Select.Option>
            </Select>
          </Form.Item>
          <Form.Item name="reminder" label="提醒時間">
            <DatePicker showTime={{ format: 'HH' }} />
          </Form.Item>
          <Form.Item>
            <Button type="primary" htmlType="submit">新增事件</Button>
          </Form.Item>
        </Form>
      );
    };

    // 主應用組件
    const CalendarApp = () => {
      const [calendarApi, setCalendarApi] = useState(null);

      const handleEventCreated = () => {
        if (calendarApi) {
          calendarApi.refetchEvents();
        }
      };

      return (
        <div>
          <EventForm onEventCreated={handleEventCreated} />
          <div id="calendar-root"></div>
        </div>
      );
    };

    ReactDOM.render(<CalendarApp />, document.getElementById('event-form-root'));

    // 全局函數
    async function showToast(message, duration, color) {
      if (window.Ionic) {
        const toast = document.createElement("ion-toast");
        toast.message = message;
        toast.duration = duration;
        toast.color = color;
        document.body.appendChild(toast);
        await toast.present();
      } else {
        alert(message);
      }
    }

    async function fetchEvents() {
      const token = localStorage.getItem("token") || sessionStorage.getItem("token");
      try {
        const response = await fetch("http://localhost:8100/calendar", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        });
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error || "無法獲取事件");
        }
        return Array.isArray(data.data.events) ? data.data.events : [];
      } catch (error) {
        console.error("獲取事件錯誤:", error);
        await showToast(`無法載入事件: ${error.message}`, 3000, "danger");
        return [];
      }
    }

    // 導航設置
    function setupNavigation() {
      const navItems = {
        "nav-dashboard": "/index.html",
        "nav-calendar": "/calendar.html",
        "nav-tasks": "/tasks.html",
        "nav-chat": "/chat.html",
        "nav-family": "/family.html",
      };

      const navList = document.getElementById("nav-list");
      if (!navList) {
        console.error("未找到 nav-list 元素");
        return;
      }

      navList.addEventListener("click", (event) => {
        const item = event.target.closest("ion-item");
        if (item && item.id in navItems) {
          const url = navItems[item.id];
          console.log(`點擊 ${item.id}，正在跳轉到 ${url}`);
          window.location.href = url;
        }
      });

      // 備用：直接綁定 ionClick 事件
      Object.keys(navItems).forEach((id) => {
        const item = document.getElementById(id);
        if (item) {
          console.log(`為 ${id} 綁定 ionClick 事件`);
          item.addEventListener("ionClick", () => {
            const url = navItems[id];
            console.log(`ionClick 觸發，跳轉到 ${url}`);
            window.location.href = url;
          });
        } else {
          console.error(`未找到元素 ${id}`);
        }
      });
    }

    // 初始化
    document.addEventListener("DOMContentLoaded", async () => {
      console.log("DOM 已載入 calendar.html");
      console.log("Ionic 版本:", window.Ionic?.version || "未載入");

      // 確保選單初始化
      const menu = document.querySelector("ion-menu");
      if (menu) {
        await menu.componentOnReady();
        console.log("ion-menu 已準備好");
      } else {
        console.error("未找到 ion-menu 元素");
      }

      const token = localStorage.getItem("token") || sessionStorage.getItem("token") || "";
      if (!token) {
        console.log("未找到 token，正在跳轉到 /login.html");
        window.location.href = "/login.html";
        return;
      }
      console.log("找到 token:", token.substring(0, 20) + "...");

      // 設置導航
      setupNavigation();

      // 登出
      const signOut = document.getElementById("signOut");
      if (signOut) {
        signOut.addEventListener("click", () => {
          console.log("點擊登出");
          localStorage.removeItem("token");
          sessionStorage.removeItem("token");
          console.log("已登出，清除 token");
          window.location.href = "/login.html";
        });
      } else {
        console.error("未找到 signOut 元素");
      }

      // 初始化 FullCalendar
      const calendarEl = document.getElementById('calendar');
      if (calendarEl) {
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          locale: 'zh-tw',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
          },
          events: async function(fetchInfo, successCallback, failureCallback) {
            const events = await fetchEvents();
            successCallback(events.map(event => ({
              title: event.title,
              start: event.start_datetime,
              end: event.end_datetime,
              extendedProps: {
                category: event.category,
                reminder: event.reminder_datetime,
              },
            })));
          },
          eventClick: function(info) {
            const event = info.event;
            showToast(
              `事件: ${event.title}\n開始: ${dayjs(event.start).format('YYYY-MM-DD HH:mm')}\n類別: ${event.extendedProps.category || '無'}`,
              3000,
              "primary"
            );
          },
        });
        calendar.render();

        // 將 calendar API 暴露給 React 組件
        const calendarApp = document.getElementById('event-form-root')._reactRootContainer._internalRoot.current.memoizedState.element.props.children[1].props;
        calendarApp.setCalendarApi(calendar);
      } else {
        console.error("未找到 calendar 元素");
      }
    });
  </script>
</body>
</html>